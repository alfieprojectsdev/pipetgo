# Production Authentication Fix - Deployment Guide

**Created:** 2025-12-01
**Issue:** Lab administrators cannot login to production (www.pipetgo.com)
**Root Cause:** Users exist in database without hashed passwords
**Fix:** Update users with bcrypt hashes from credential file

---

## Executive Summary

**Problem:**
- Lab admins cannot login at www.pipetgo.com
- 500 Internal Server Error on authentication
- hashedPassword field is NULL in production database

**Solution:**
- Update 4 lab admin accounts with hashed passwords
- Passwords already exist in LAB_ACCOUNT_CREDENTIALS.md
- Use bcrypt hashes generated by scripts/hash-existing-passwords.ts

**Impact:**
- Zero downtime (database-only change)
- No code deployment required
- Immediate fix once SQL executed
- Affects only LAB_ADMIN role users

**Time Required:**
- SQL execution: 2 minutes
- Testing: 5 minutes
- Total: ~10 minutes

---

## Pre-Deployment Checklist

- [ ] Access to Neon production database console
- [ ] Copy of ALL_ACCOUNT_CREDENTIALS.md for password verification
- [ ] Backup of current User table (Neon automatic backups enabled)
- [ ] Testing account credentials ready (lab1@pgtestinglab.com)
- [ ] Browser ready to test login at www.pipetgo.com

---

## Step-by-Step Deployment

### Step 1: Access Production Database

1. Go to [Neon Console](https://console.neon.tech)
2. Select PipetGo production project
3. Navigate to SQL Editor
4. Verify database connection is active

### Step 2: Verify Current State

Run this query to check existing users:

```sql
SELECT
  email,
  role,
  "hashedPassword" IS NOT NULL as has_password,
  "createdAt"
FROM "User"
WHERE email IN (
  'lab1@pgtestinglab.com',
  'lab2@pgtestlab.com',
  'lab3@pgtstlab.com',
  'lab4@testlabpg.com'
)
ORDER BY email;
```

**Expected result:**
- 4 rows returned
- All with `role = LAB_ADMIN`
- All with `has_password = false` (NULL hashedPassword)

**If users DO NOT exist:**
Stop here and create users first (see Appendix A).

### Step 3: Execute Password Updates

Copy and paste the entire SQL script from `scripts/update-production-passwords.sql`:

```sql
BEGIN;

UPDATE "User"
SET
  "hashedPassword" = '$2b$12$h/kWZYI1SIPahWOiWtprveXbw/Tzpgyr0wOaPik/kZvAb49UFl/YK',
  "updatedAt" = NOW()
WHERE email = 'lab1@pgtestinglab.com';

UPDATE "User"
SET
  "hashedPassword" = '$2b$12$/45QGazcH0DIKJfpi72GoeE/.I.Nk90sV/BSh2qJTR2n48h51R.sK',
  "updatedAt" = NOW()
WHERE email = 'lab2@pgtestlab.com';

UPDATE "User"
SET
  "hashedPassword" = '$2b$12$Mwev5yrkJvg7ffg3uGrpG.B2wsX7qFT/Akzl.IIgzkR6tXSAfOOqe',
  "updatedAt" = NOW()
WHERE email = 'lab3@pgtstlab.com';

UPDATE "User"
SET
  "hashedPassword" = '$2b$12$lRbw1CRpZaCTwU.V3yeMI.7pl5EVjOvgAHXCBMy94BKbmbl9hKNIC',
  "updatedAt" = NOW()
WHERE email = 'lab4@testlabpg.com';

COMMIT;
```

**Expected output:**
- Transaction successful
- 4 rows updated

### Step 4: Verify Updates

Run verification query:

```sql
SELECT
  email,
  role,
  "hashedPassword" IS NOT NULL as has_password,
  LEFT("hashedPassword", 10) as hash_preview,
  "updatedAt"
FROM "User"
WHERE email IN (
  'lab1@pgtestinglab.com',
  'lab2@pgtestlab.com',
  'lab3@pgtstlab.com',
  'lab4@testlabpg.com'
)
ORDER BY email;
```

**Expected result:**
- 4 rows returned
- All with `has_password = true`
- All with `hash_preview` starting with `$2b$12$`
- All with recent `updatedAt` timestamp

### Step 5: Test Login (CRITICAL)

**Test with ONE account first:**

1. Go to https://www.pipetgo.com/auth/signin
2. Enter email: `lab1@pgtestinglab.com`
3. Enter password from ALL_ACCOUNT_CREDENTIALS.md: `HSmgGnbBcZ!zRsGQsnDkNHnu`
4. Click "Sign In"

**Expected:** Successful login → Redirect to lab dashboard

**If login fails:**
- Check browser console for errors
- Verify password copied correctly (no extra spaces)
- Check Vercel deployment logs for server errors
- Run rollback script (see Step 6)

**If login succeeds:**
- ✅ Fix is working!
- Test remaining 3 accounts (optional but recommended)
- Notify lab admins their accounts are ready

### Step 6: Rollback (If Needed)

If something goes wrong, rollback is simple:

```sql
BEGIN;

UPDATE "User"
SET
  "hashedPassword" = NULL,
  "updatedAt" = NOW()
WHERE email IN (
  'lab1@pgtestinglab.com',
  'lab2@pgtestlab.com',
  'lab3@pgtstlab.com',
  'lab4@testlabpg.com'
);

COMMIT;
```

This returns users to previous state (no passwords).

---

## Post-Deployment Tasks

### Immediate (Within 1 hour)

- [ ] Test all 4 lab admin accounts
- [ ] Document successful login times
- [ ] Notify CEO: "Lab admin authentication fixed"
- [ ] Update status page (if applicable)

### Short-term (Within 24 hours)

- [ ] Send credentials to actual lab admins via secure channel
- [ ] Instruct lab admins to test login
- [ ] Monitor authentication logs for issues
- [ ] Document lessons learned

### Medium-term (Within 1 week)

- [ ] Review seed scripts to prevent recurrence
- [ ] Add validation to prevent LAB_ADMIN creation without password
- [ ] Improve error handling in auth flow (no more empty JSON)
- [ ] Consider implementing password reset flow

---

## Troubleshooting

### Issue: "Email not found"

**Symptoms:**
- Login fails immediately
- Error message: "Invalid email or password"

**Diagnosis:**
```sql
SELECT * FROM "User" WHERE email = 'lab1@pgtestinglab.com';
```

**Resolution:**
- User doesn't exist in database
- Create user first (see Appendix A)

### Issue: "500 Internal Server Error"

**Symptoms:**
- Server error on login
- Console shows: "Unexpected end of JSON input"

**Diagnosis:**
- Check Vercel logs for actual error
- Verify NEXTAUTH_SECRET set in Vercel environment variables
- Check DATABASE_URL connection string

**Resolution:**
1. Go to Vercel dashboard
2. Check Functions > Logs
3. Look for authentication errors
4. Verify environment variables in Settings

### Issue: "Invalid password"

**Symptoms:**
- Login fails with "Invalid email or password"
- User exists in database

**Diagnosis:**
```sql
SELECT
  email,
  "hashedPassword",
  LENGTH("hashedPassword") as hash_length
FROM "User"
WHERE email = 'lab1@pgtestinglab.com';
```

**Resolution:**
- Verify password copied correctly from credentials file
- Check hash length is 60 characters (bcrypt standard)
- Regenerate hash if corrupted (scripts/hash-existing-passwords.ts)

---

## Monitoring & Alerts

### Success Metrics

After deployment, monitor:

1. **Authentication success rate:**
   ```sql
   SELECT COUNT(*) as active_sessions
   FROM "Session"
   WHERE "userId" IN (
     SELECT id FROM "User" WHERE role = 'LAB_ADMIN'
   )
   AND "expires" > NOW();
   ```

2. **Recent login activity:**
   ```sql
   SELECT
     u.email,
     s."expires",
     s."sessionToken"
   FROM "Session" s
   JOIN "User" u ON u.id = s."userId"
   WHERE u.role = 'LAB_ADMIN'
   ORDER BY s."expires" DESC
   LIMIT 10;
   ```

### Failure Indicators

If any of these occur, investigate immediately:

- Zero sessions created after 1 hour
- Multiple failed login attempts (when logging implemented)
- 500 errors in Vercel logs
- User reports still unable to login

---

## Communication Plan

### Before Deployment

**To CEO:**
> Subject: Production Authentication Fix - Scheduled
>
> We're deploying a fix for lab administrator login issues today at [TIME].
>
> - Duration: ~10 minutes
> - Impact: None (database-only change)
> - Outcome: Lab admins can login with credentials from secure document
>
> Will confirm success after testing.

### After Successful Deployment

**To CEO:**
> Subject: ✅ Lab Admin Authentication Fixed
>
> Production fix deployed successfully. All 4 lab admin accounts tested:
>
> ✅ lab1@pgtestinglab.com - Working
> ✅ lab2@pgtestlab.com - Working
> ✅ lab3@pgtstlab.com - Working
> ✅ lab4@testlabpg.com - Working
>
> Ready to distribute credentials to actual lab admins.
> Credentials are in ALL_ACCOUNT_CREDENTIALS.md (secure document).

**To Lab Admins (via CEO):**
> Subject: PipetGo Lab Portal - Account Credentials
>
> Your PipetGo lab administrator account is now active.
>
> Login URL: https://www.pipetgo.com/auth/signin
> Email: [from credentials document]
> Password: [from credentials document]
>
> Please:
> 1. Test login within 24 hours
> 2. Store password in secure password manager
> 3. Report any issues to [support email]
>
> For security, change your password on first login (feature coming soon).

---

## Appendix A: Creating Users (If Not Exist)

If users don't exist in production database, create them first:

```sql
BEGIN;

INSERT INTO "User" (id, email, name, role, "createdAt", "updatedAt")
VALUES
  (gen_random_uuid(), 'lab1@pgtestinglab.com', 'Testing Lab 1 Admin', 'LAB_ADMIN', NOW(), NOW()),
  (gen_random_uuid(), 'lab2@pgtestlab.com', 'Testing Lab 2 Admin', 'LAB_ADMIN', NOW(), NOW()),
  (gen_random_uuid(), 'lab3@pgtstlab.com', 'Testing Lab 3 Admin', 'LAB_ADMIN', NOW(), NOW()),
  (gen_random_uuid(), 'lab4@testlabpg.com', 'Testing Lab 4 Admin', 'LAB_ADMIN', NOW(), NOW());

COMMIT;
```

Then proceed with Step 3 (password updates).

---

## Appendix B: Verifying Bcrypt Hashes

To verify a password hash was generated correctly:

```bash
# Run locally
node -e "
const bcrypt = require('bcryptjs');
const password = 'HSmgGnbBcZ!zRsGQsnDkNHnu';
const hash = '\$2b\$12\$h/kWZYI1SIPahWOiWtprveXbw/Tzpgyr0wOaPik/kZvAb49UFl/YK';
bcrypt.compare(password, hash).then(result => {
  console.log('Password matches hash:', result);
});
"
```

Expected output: `Password matches hash: true`

---

## Appendix C: Alternative Deployment Methods

### Method 1: Prisma Migration (More formal)

1. Create migration file:
```bash
npx prisma migrate dev --name add_lab_admin_passwords
```

2. Edit migration SQL to include password updates

3. Deploy to production:
```bash
npx prisma migrate deploy
```

**Pros:** Version controlled, reversible
**Cons:** Slower, requires new deployment

### Method 2: Seed Script Update

1. Update `prisma/seed.ts` with hashed passwords
2. Run seed in production:
```bash
npm run db:seed
```

**Pros:** Idempotent, repeatable
**Cons:** May create duplicate users if not using upsert

---

**Last Updated:** 2025-12-01
**Author:** Development Team
**Review Status:** Ready for deployment
